# Copyright (C) Igor Sysoev
# Copyright (C) NGINX, Inc.

# Linux clone syscall.

nsflags="USER NS PID NET UTS IPC CGROUP"

nxt_feature="clone(2)"
nxt_feature_name=NXT_HAVE_CLONE
nxt_feature_run=no
nxt_feature_incs=
nxt_feature_libs=
nxt_feature_test="#include <sys/wait.h>
                  #include <sys/syscall.h>

                  int main() {
                      return __NR_clone | SIGCHLD;
                  }"
. auto/feature

if [ $nxt_found = yes ]; then
    NXT_HAVE_CLONE=YES
    
    # Test all isolation flags
    for flag in $nsflags; do
        nxt_feature="CLONE_NEW${flag}"
        nxt_feature_name=NXT_HAVE_CLONE_NEW${flag}
        nxt_feature_run=no
        nxt_feature_incs=
        nxt_feature_libs=
        nxt_feature_test="#define _GNU_SOURCE
                          #include <sys/wait.h>
                          #include <sys/syscall.h>
                          #include <sched.h>

                          int main() {
                              return CLONE_NEW$flag;
                         }"
        . auto/feature

        eval "NXT_HAVE_CLONE_NEW$flag=$nxt_found"
    done
else
    NXT_HAVE_CLONE=NO
fi

NXT_ISOLATION=NO

if [ $NXT_HAVE_CLONE = "YES" ]; then 
    # test if at least one isolation flag was detected
    for flag in $nsflags; do
        flagname="$echo -n \$NXT_HAVE_CLONE_NEW$flag"
        has=`eval $flagname`
        
        if [ $has = "yes" ]; then
            NXT_ISOLATION=YES 
            break
        fi
    done
fi 