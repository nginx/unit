# Copyright (C) Igor Sysoev
# Copyright (C) NGINX, Inc.


# Linux clone syscall.

nxt_feature="Linux unprivileged clone(2)"
nxt_feature_name=NXT_HAVE_CLONE
nxt_feature_run=yes
nxt_feature_incs=
nxt_feature_libs=
nxt_feature_test="#define _GNU_SOURCE
                  #include <errno.h>
                  #include <sys/types.h>
                  #include <sys/wait.h>
                  #include <unistd.h>
                  #include <sys/syscall.h>
                  #include <sched.h>

                  int main() {
                      int wstatus;
                      int pid = syscall(SYS_clone, CLONE_NEWUSER|SIGCHLD, NULL);
                      if (pid < 0) return 1;
                      if (pid == 0) return 0;

                      // parent
                      waitpid(pid, &wstatus, 0);
                      if (WIFEXITED(wstatus))
                          return WEXITSTATUS(wstatus);
                      return 1;
                   }"
. auto/feature

if [ $nxt_found = yes ]; then
    NXT_HAVE_CLONE=YES
    
    # Test all isolation flags are unprivileged
    nsflags="NS PID NET UTS IPC CGROUP"
    for flag in $nsflags; do
        nxt_feature="Linux NEW${flag}"
        nxt_feature_name=NXT_HAVE_NEW${flag}
        nxt_feature_run=yes
        nxt_feature_incs=
        nxt_feature_libs=
        nxt_feature_test="#define _GNU_SOURCE
                    #include <errno.h>
                    #include <sys/types.h>
                    #include <sys/wait.h>
                    #include <unistd.h>
                    #include <sys/syscall.h>
                    #include <sched.h>

                    int main() {
                        int wstatus;
                        int pid = syscall(SYS_clone, CLONE_NEWUSER|CLONE_NEW${flag}|SIGCHLD, NULL);
                        if (pid < 0) return 1;
                        if (pid == 0) return 0;

                        // parent
                        waitpid(pid, &wstatus, 0);
                        if (WIFEXITED(wstatus))
                            return WEXITSTATUS(wstatus);
                        return 1;
                    }"
        . auto/feature
    done
else
    NXT_HAVE_CLONE=NO
fi